name: Release

on:
  push:
    branches: [main]

concurrency:
  group: release-main
  cancel-in-progress: false

permissions:
  contents: write
  actions: write

jobs:
  release:
    name: Conventional Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Preflight release tag ancestry
        run: |
          set -euo pipefail
          git fetch --tags --force
          LAST_TAG=$(git tag --list 'v*' --sort=-version:refname | head -n 1)
          if [[ -z "${LAST_TAG}" ]]; then
            echo "No existing release tags found. Continuing."
            exit 0
          fi

          LAST_TAG_COMMIT=$(git rev-list -n 1 "${LAST_TAG}")
          if git merge-base --is-ancestor "${LAST_TAG_COMMIT}" HEAD; then
            echo "Latest tag ${LAST_TAG} is reachable from main."
            exit 0
          fi

          echo "::error::Latest tag ${LAST_TAG} (${LAST_TAG_COMMIT}) is not reachable from main (${GITHUB_SHA})."
          echo "::error::Release history is divergent."
          echo "::error::Fix by force-moving the tag to a commit reachable from main (tag-only operation), then rerun release."
          exit 1

      - name: Cocogitto release
        id: release
        continue-on-error: true
        uses: cocogitto/cocogitto-action@9a9fe03b31c47444290c0d7f9b1ee1b44ee13f20 # v4.1.0
        with:
          command: bump
          args: --auto
          git-user: 'github-actions[bot]'
          git-user-email: 'github-actions[bot]@users.noreply.github.com'

      - name: Validate release outcome
        if: steps.release.outcome == 'failure'
        run: |
          RELEASE_STDOUT_LOWER="$(echo "${{ steps.release.outputs.stdout }}" | tr '[:upper:]' '[:lower:]')"
          if [[ "${RELEASE_STDOUT_LOWER}" == *"no conventional commit"* ]]; then
            echo "No releasable conventional commits found. Skipping release."
            exit 0
          fi

          if [[ "${RELEASE_STDOUT_LOWER}" == *"tag already exists"* ]]; then
            echo "::error::Cocogitto tried to create an existing tag."
            echo "::error::Most likely reason: release tag/main history divergence."
            echo "${{ steps.release.outputs.stdout }}"
            exit 1
          fi

          echo "Cocogitto failed with unexpected error:"
          echo "${{ steps.release.outputs.stdout }}"
          exit 1

      - name: Push release tag only
        if: steps.release.outputs.version != ''
        run: git push origin "${{ steps.release.outputs.version }}"

      - name: Set up JDK 25
        if: steps.release.outputs.version != ''
        uses: actions/setup-java@v5
        with:
          java-version: '25'
          distribution: 'temurin'
          cache: maven

      - name: Build release JAR
        if: steps.release.outputs.version != ''
        run: ./mvnw clean package -DskipTests -DskipGitHooks=true

      - name: Prepare release assets
        if: steps.release.outputs.version != ''
        id: assets
        run: |
          JAR_PATH=$(find target -maxdepth 1 -type f -name 'bot-*.jar' ! -name '*.jar.original' | sort | head -n 1)
          if [[ -z "${JAR_PATH}" ]]; then
            echo "Release jar not found (expected target/bot-*.jar)." >&2
            exit 1
          fi
          JAR_NAME=$(basename "${JAR_PATH}")
          SHA_FILE=sha256sums.txt
          sha256sum "${JAR_PATH}" | awk -v jar="${JAR_NAME}" '{print $1 "  " jar}' > "${SHA_FILE}"
          echo "jar-path=${JAR_PATH}" >> "${GITHUB_OUTPUT}"
          echo "sha-file=${SHA_FILE}" >> "${GITHUB_OUTPUT}"

      - name: Create or update GitHub Release
        if: steps.release.outputs.version != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_TAG: ${{ steps.release.outputs.version }}
          RELEASE_JAR: ${{ steps.assets.outputs.jar-path }}
          RELEASE_SHA: ${{ steps.assets.outputs.sha-file }}
        run: |
          if gh release view "${RELEASE_TAG}" >/dev/null 2>&1; then
            gh release upload "${RELEASE_TAG}" "${RELEASE_JAR}" "${RELEASE_SHA}" --clobber
          else
            gh release create "${RELEASE_TAG}" "${RELEASE_JAR}" "${RELEASE_SHA}" \
              --title "${RELEASE_TAG}" \
              --generate-notes
          fi

      - name: Trigger Docker publish for release tag
        if: steps.release.outputs.version != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh workflow run docker-publish.yml --ref "${{ steps.release.outputs.version }}"

      - name: Summary
        if: steps.release.outputs.version != ''
        run: |
          echo "## Release ${{ steps.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tag \`${{ steps.release.outputs.version }}\` pushed (main push intentionally disabled by branch rules)." >> $GITHUB_STEP_SUMMARY
          echo "GitHub Release with \`bot-*.jar\` and \`sha256sums.txt\` was published." >> $GITHUB_STEP_SUMMARY
